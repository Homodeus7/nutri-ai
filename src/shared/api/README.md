# API Configuration

This directory contains the API configuration for the Nutri AI application following Feature-Sliced Design (FSD) architecture.

## Structure

```
src/shared/api/
├── schema.yml          # OpenAPI 3.0 specification
├── api-instace.ts          # Custom Axios instance with interceptors for Orval
├── index.ts            # Public exports
└── generated/          # Auto-generated by Orval (do not edit manually)
    ├── model/          # TypeScript types
    └── *.ts            # API hooks per tag
```

## Setup

1. **Install dependencies**:
```bash
npm install
```

2. **Configure environment variables**:
```bash
cp .env.example .env.local
```

Edit `.env.local` and set:
```env
NEXT_PUBLIC_API_URL=http://localhost:3000/api
```

3. **Generate API client**:
```bash
npm run generate:api
```

This will generate:
- TypeScript types from OpenAPI schema
- React Query hooks for all endpoints
- Organized by OpenAPI tags (Auth, Calendar, Day, Meals, AI, Plans, Stats)

## Usage

### Using generated hooks in components:

```tsx
'use client';

import { useGetCalendar, usePostDayDateMeals } from '@/shared/api/generated/calendar';

export function CalendarView() {
  // GET request
  const { data, isLoading, error } = useGetCalendar({
    month: '2025-10',
  });

  // POST mutation
  const { mutate: createMeal } = usePostDayDateMeals();

  const handleAddMeal = () => {
    createMeal({
      date: '2025-10-20',
      data: {
        type: 'breakfast',
        totalKcal: 350,
        source: 'manual',
        name: 'Завтрак',
      },
    });
  };

  if (isLoading) return <div>Loading...</div>;
  if (error) return <div>Error: {error.message}</div>;

  return <div>{/* render calendar */}</div>;
}
```

### Authentication

The Axios instance automatically adds the JWT token from `localStorage` to all requests:

```typescript
// Login example
const handleLogin = async (email: string, password: string) => {
  const response = await axios.post('/auth/login', { email, password });
  localStorage.setItem('authToken', response.data.token);
};

// Google OAuth login
const handleGoogleLogin = async (idToken: string) => {
  const response = await axios.post('/auth/google', { idToken });
  localStorage.setItem('authToken', response.data.token);
};
```

### Custom Axios configuration

The mutator (`mutator.ts`) includes:
- Automatic Bearer token injection
- 401 error handling with auto-logout
- Request/response interceptors
- Cancel token support

## React Query Provider

Add the QueryProvider to your root layout:

```tsx
// src/app/layout.tsx
import { QueryProvider } from '@/shared/lib/react-query';

export default function RootLayout({ children }) {
  return (
    <html>
      <body>
        <QueryProvider>
          {children}
        </QueryProvider>
      </body>
    </html>
  );
}
```

## Regenerating API

When you update `schema.yml`, regenerate the API client:

```bash
npm run generate:api
```

## Context7 Integration (if using)

If you're using Context7 or another auth provider, update the token retrieval in `mutator.ts`:

```typescript
// Example with Context7
import { useAuth } from 'context7'; // or your auth library

AXIOS_INSTANCE.interceptors.request.use(
  async (config) => {
    const { getToken } = useAuth();
    const token = await getToken();

    if (token && config.headers) {
      config.headers.Authorization = `Bearer ${token}`;
    }
    return config;
  }
);
```

## Learn More

- [Orval Documentation](https://orval.dev)
- [React Query Documentation](https://tanstack.com/query/latest)
- [Axios Documentation](https://axios-http.com/)
