# Nutri AI — Техническая спецификация

> Бизнес-требования, API спецификация и описание сущностей для разработки приложения учёта калорий.

---

## Содержание

1. [Цель проекта](#1-цель-проекта)
2. [Пользовательские сценарии](#2-пользовательские-сценарии)
3. [Экраны приложения](#3-экраны-приложения)
4. [AI-интеграция](#4-ai-интеграция)
5. [Модель данных](#5-модель-данных)
6. [API спецификация](#6-api-спецификация)
7. [Правила валидации](#7-правила-валидации)
8. [Безопасность](#8-безопасность)
9. [Мониторинг и метрики](#9-мониторинг-и-метрики)
10. [Важные замечания](#10-важные-замечания)

---

## 1. Цель проекта

Веб-приложение для учёта и подсчёта калорий с возможностью:

- Ввода приёма пищи через AI (естественный язык)
- Отслеживания прогресса по календарю
- Управления целями питания
- Просмотра статистики потребления

---

## 2. Пользовательские сценарии

### 2.1 Основные флоу

1. **Просмотр календаря**
   - Выбор месяца
   - Индикация прогресса по дням (% от цели)
   - Переход к детальному просмотру дня

2. **Заполнение дня**
   - Просмотр списка приёмов пищи за выбранную дату
   - Добавление приёма (вручную/через AI)
   - Редактирование и удаление приёмов
   - Просмотр итоговой статистики дня

3. **Настройка плана питания**
   - Создание/выбор диеты
   - Указание целевой калорийности
   - Настройка соотношения макронутриентов (Б/Ж/У)
   - Применение плана глобально или к конкретной дате

4. **AI-парсинг приёма пищи**
   - Ввод текстового описания (например: "завтрак: овсянка 50г с бананом и мёдом, кофе с молоком")
   - Получение распарсенного результата
   - Проверка и корректировка данных
   - Сохранение приёма

---

## 3. Экраны приложения

### 3.1 Главная — Календарь

**Элементы:**

- Отображение месяца с датами
- Индикаторы заполнения цели на каждый день (0-100%)
- Навигация между месяцами
- Кнопка "Сегодня" для быстрого перехода

**Взаимодействие:**

- Клик по дню → переход на экран заполнения дня

---

### 3.2 Экран заполнения дня

**Элементы:**

- Заголовок с выбранной датой
- Список приёмов пищи (завтрак, обед, ужин, перекусы)
- Круговой график заполнения цели (0-100%)
- Итоговая информация: потреблено/цель калорий
- Кнопка "Добавить приём"

**Взаимодействие:**

- Добавление → выбор способа (вручную/через AI)
- Редактирование → открытие модального окна
- Удаление → подтверждение действия

---

### 3.3 Настройки плана питания

**Элементы:**

- Список доступных планов питания
- Форма создания нового плана
- Настройки целевой калорийности
- Опциональные настройки макронутриентов
- Кнопка применения плана

**Взаимодействие:**

- Применение плана к пользователю (глобально)
- Применение плана к конкретной дате (переопределение)

---

### 3.4 Добавление через AI

**Элементы:**

- Текстовое поле для ввода описания
- Кнопка "Распарсить"
- Список распознанных позиций
- Поля для корректировки данных
- Кнопка "Сохранить"

**Взаимодействие:**

- Отправка текста на AI API
- Отображение результата с возможностью редактирования
- Сохранение с указанием типа приёма (завтрак/обед/ужин/перекус)

---

## 4. AI-интеграция

### 4.1 Назначение

Преобразование свободного текста о приёме пищи в структурированные данные с оценкой калорий и макронутриентов.

### 4.2 Формат запроса

**Endpoint:** `POST /ai/parse-meal`

**Request:**

```json
{
  "userId": "string (UUID)",
  "date": "YYYY-MM-DD",
  "timezone": "America/New_York",
  "text": "завтрак: овсянка 50г с бананом и мёдом, кофе с молоком"
}
```

### 4.3 Формат ответа

```json
{
  "parsedItems": [
    {
      "name": "Овсянка",
      "quantity": 50,
      "unit": "g",
      "kcal": 185,
      "protein": 6.5,
      "fat": 3.5,
      "carbs": 33.0,
      "confidence": 0.95
    },
    {
      "name": "Банан",
      "quantity": 1,
      "unit": "piece",
      "kcal": 89,
      "protein": 1.1,
      "fat": 0.3,
      "carbs": 23.0,
      "confidence": 0.88
    }
  ],
  "totalKcal": 320,
  "warnings": [
    "Мёд - количество не указано, использована стандартная порция (1 ч.л.)"
  ]
}
```

### 4.4 Рекомендации по реализации

- Синхронный HTTP POST с таймаутом 30 сек
- Логирование всех запросов/ответов (для улучшения модели)
- Валидация `kcal` и округление до целого
- Если `confidence < 0.6` → пометить как требующее проверки
- Ограничение длины текста: максимум 2048 символов

---

## 5. Модель данных

### 5.1 User

**Описание:** Пользователь системы

| Поле            | Тип      | Обязательно | Описание                    |
| --------------- | -------- | ----------- | --------------------------- |
| `id`            | UUID     | Да          | Уникальный идентификатор    |
| `email`         | String   | Да          | Email для входа             |
| `passwordHash`  | String   | Да          | Хеш пароля                  |
| `displayName`   | String   | Нет         | Отображаемое имя            |
| `timezone`      | String   | Нет         | Часовой пояс (IANA формат)  |
| `dailyKcalGoal` | Integer  | Нет         | Целевая калорийность в день |
| `createdAt`     | DateTime | Да          | Дата регистрации            |

---

### 5.2 DayEntry

**Описание:** Запись о дне пользователя

| Поле           | Тип      | Обязательно | Описание                                |
| -------------- | -------- | ----------- | --------------------------------------- |
| `id`           | UUID     | Да          | Уникальный идентификатор                |
| `userId`       | UUID     | Да          | FK → User.id                            |
| `date`         | Date     | Да          | Дата в формате YYYY-MM-DD               |
| `targetKcal`   | Integer  | Нет         | Переопределённая цель на день           |
| `consumedKcal` | Integer  | Нет         | Вычисляемое поле (сумма meal.totalKcal) |
| `notes`        | String   | Нет         | Заметки пользователя                    |
| `createdAt`    | DateTime | Да          | Дата создания                           |
| `updatedAt`    | DateTime | Да          | Дата последнего изменения               |

---

### 5.3 Meal

**Описание:** Приём пищи

| Поле           | Тип      | Обязательно | Описание                                   |
| -------------- | -------- | ----------- | ------------------------------------------ |
| `id`           | UUID     | Да          | Уникальный идентификатор                   |
| `dayEntryId`   | UUID     | Да          | FK → DayEntry.id                           |
| `type`         | Enum     | Да          | breakfast / lunch / dinner / snack / other |
| `time`         | Time     | Нет         | Время приёма (HH:MM)                       |
| `name`         | String   | Нет         | Название приёма                            |
| `items`        | Array    | Нет         | Массив FoodItem                            |
| `totalKcal`    | Integer  | Да          | Сумма калорий (или ручной ввод)            |
| `source`       | Enum     | Да          | manual / ai                                |
| `aiConfidence` | Float    | Нет         | Уверенность AI (0.0-1.0)                   |
| `createdAt`    | DateTime | Да          | Дата создания                              |
| `updatedAt`    | DateTime | Да          | Дата последнего изменения                  |

---

### 5.4 FoodItem

**Описание:** Позиция продукта в приёме пищи

| Поле       | Тип     | Обязательно | Описание                               |
| ---------- | ------- | ----------- | -------------------------------------- |
| `id`       | UUID    | Да          | Уникальный идентификатор               |
| `mealId`   | UUID    | Да          | FK → Meal.id                           |
| `name`     | String  | Да          | Название продукта/блюда                |
| `quantity` | Float   | Да          | Количество                             |
| `unit`     | String  | Да          | Единица измерения (g, ml, piece, tbsp) |
| `kcal`     | Integer | Да          | Калории для указанного количества      |
| `protein`  | Float   | Нет         | Белки (г)                              |
| `fat`      | Float   | Нет         | Жиры (г)                               |
| `carbs`    | Float   | Нет         | Углеводы (г)                           |
| `source`   | String  | Нет         | Источник данных (база продуктов)       |

---

### 5.5 DietPlan

**Описание:** План питания

| Поле          | Тип      | Обязательно | Описание                           |
| ------------- | -------- | ----------- | ---------------------------------- |
| `id`          | UUID     | Да          | Уникальный идентификатор           |
| `userId`      | UUID     | Нет         | FK → User.id (null для глобальных) |
| `name`        | String   | Да          | Название плана                     |
| `targetKcal`  | Integer  | Да          | Целевая калорийность               |
| `macros`      | Object   | Нет         | `{ proteinPct, fatPct, carbsPct }` |
| `description` | String   | Нет         | Описание плана                     |
| `createdAt`   | DateTime | Да          | Дата создания                      |
| `updatedAt`   | DateTime | Да          | Дата последнего изменения          |

---

### 5.6 AiParseLog

**Описание:** Логи AI-парсинга для аналитики

| Поле              | Тип      | Обязательно | Описание                             |
| ----------------- | -------- | ----------- | ------------------------------------ |
| `id`              | UUID     | Да          | Уникальный идентификатор             |
| `userId`          | UUID     | Нет         | FK → User.id                         |
| `requestText`     | Text     | Да          | Исходный текст от пользователя       |
| `requestPayload`  | JSON     | Да          | Полный запрос (date, timezone и др.) |
| `responsePayload` | JSON     | Да          | Полный ответ от AI                   |
| `responseTimeMs`  | Integer  | Да          | Время ответа в миллисекундах         |
| `createdAt`       | DateTime | Да          | Дата создания                        |

---

## 6. API спецификация

### 6.1 Авторизация

**POST** `/auth/signup`

- Регистрация нового пользователя
- Body: `{ email, password, displayName? }`
- Response: `{ user, tokens }`

**POST** `/auth/login`

- Получение токена доступа
- Body: `{ email, password }`
- Response: `{ user, tokens }`

---

### 6.2 Календарь

**GET** `/calendar?month=YYYY-MM`

- Получение данных по дням за месяц
- Response: `{ days: [{ date, consumedKcal, targetKcal, consumedPercent }] }`

---

### 6.3 Дневные записи

**GET** `/day/:date`

- Получение DayEntry + meals + items для даты
- Response: `{ dayEntry, meals: [{ ...meal, items: [...] }] }`

**POST** `/day/:date/meals`

- Создание нового приёма пищи
- Body: `{ type, time?, name?, items?, totalKcal, source }`
- Response: `{ meal }`

---

### 6.4 Приёмы пищи

**PUT** `/meals/:id`

- Обновление приёма пищи
- Body: `{ type?, time?, name?, items?, totalKcal? }`
- Response: `{ meal }`

**DELETE** `/meals/:id`

- Удаление приёма пищи
- Response: `{ success: true }`

---

### 6.5 AI

**POST** `/ai/parse-meal`

- Парсинг текста через AI
- Body: `{ userId, date, timezone?, text }`
- Response: `{ parsedItems, totalKcal, warnings }`

---

### 6.6 Планы питания

**GET** `/plans`

- Список доступных планов
- Response: `{ plans: [...] }`

**POST** `/plans/:id/apply`

- Применение плана к пользователю или дате
- Query: `?date=YYYY-MM-DD` (опционально)
- Response: `{ success: true }`

---

### 6.7 Статистика

**GET** `/stats?from=YYYY-MM-DD&to=YYYY-MM-DD`

- Агрегированная статистика за период
- Response: `{ totalKcal, avgKcal, goalCompletion, ... }`

---

## 7. Правила валидации

### 7.1 Общие правила

- `kcal` — integer ≥ 0
- `date` — строго формат YYYY-MM-DD
- `time` — формат HH:MM или null
- `timezone` — IANA формат (например: "America/New_York")
- Текст для AI — максимум 2048 символов

### 7.2 AI-специфичные правила

- При `source = ai` и `aiConfidence < 0.6` → пометить как требующее проверки
- Округление калорий до целого числа
- Автоматическая проверка на разумность значений (kcal < 10000 на продукт)

---

## 8. Безопасность

### 8.1 Аутентификация

- JWT или сессии
- Все API кроме `/auth/*` требуют авторизации
- Токены с ограниченным временем жизни

### 8.2 Приватность данных

- Доступ только владельцу данных
- Логи AI без персональных данных или с шифрованием
- GDPR compliance (возможность экспорта/удаления данных)

---

## 9. Мониторинг и метрики

### 9.1 Обязательные метрики

- Логи ошибок бэкенда
- AI timeouts и failures
- Количество AI-запросов в день
- Среднее время ответа AI
- Процент low-confidence парсинга (<0.6)

### 9.2 Опциональные метрики

- Активность пользователей (DAU/MAU)
- Средняя калорийность по пользователям
- Популярные продукты

---

## 10. Важные замечания

1. **Timezone Support**
   - Всегда учитывать часовой пояс пользователя
   - Хранить даты в UTC, конвертировать при отображении

2. **Округление калорий**
   - Хранить только целые числа
   - Отображать без дробной части

3. **Производительность**
   - Кеширование планов питания
   - Индексы на userId + date для быстрого поиска
   - Пагинация для больших списков

4. **Будущие улучшения**
   - База продуктов для автодополнения
   - Избранные блюда/рецепты
   - Статистика по макронутриентам
   - Экспорт данных в CSV/PDF
