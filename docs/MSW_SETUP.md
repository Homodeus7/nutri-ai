# MSW (Mock Service Worker) Setup Guide

## Overview

This project uses MSW (Mock Service Worker) to intercept API requests and return mock data during development. This allows you to develop the frontend without needing a running backend server.

## How It Works

MSW uses a Service Worker to intercept network requests in the browser and return mock responses based on predefined handlers. The mock handlers are automatically generated by Orval from your OpenAPI specification.

### Architecture

```
Browser Request
     â†“
Service Worker (mockServiceWorker.js)
     â†“
MSW Handlers (from orval)
     â†“
Mock Response (faker-generated data)
```

## Configuration

### Environment Variables

MSW is controlled by environment variables in `.env`:

```bash
# Use mock API (MSW) instead of real API
# Set to "true" for development with mocks
# Set to "false" for production or when using real API
NEXT_PUBLIC_USE_MOCK_API=true

# API Base URL (used when USE_MOCK_API=false)
NEXT_PUBLIC_API_BASE_URL=http://localhost:3333/api
```

### Modes

**1. Mock Mode (Development)**
```bash
NEXT_PUBLIC_USE_MOCK_API=true
```
- All API requests are intercepted by MSW
- Returns faker-generated mock data
- No backend server needed
- Perfect for frontend development

**2. Production Mode**
```bash
NEXT_PUBLIC_USE_MOCK_API=false
NEXT_PUBLIC_API_BASE_URL=https://your-production-api.com/api
```
- MSW is disabled
- Requests go to real API
- Used in production or when backend is available

## File Structure

```
src/
â”œâ”€â”€ shared/
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â””â”€â”€ generated/
â”‚   â”‚       â””â”€â”€ nutriAIFoodCalorieTrackerAPI.ts  # Auto-generated with mock handlers
â”‚   â””â”€â”€ lib/
â”‚       â””â”€â”€ msw/
â”‚           â”œâ”€â”€ browser.ts                        # MSW worker setup
â”‚           â”œâ”€â”€ init-msw.ts                       # MSW initialization
â”‚           â”œâ”€â”€ msw-provider.tsx                  # React provider component
â”‚           â””â”€â”€ index.ts
â””â”€â”€ app/
    â””â”€â”€ providers/
        â””â”€â”€ app-provider.tsx                      # Wraps app with MSWProvider

public/
â””â”€â”€ mockServiceWorker.js                          # MSW service worker script
```

## Mock Handlers

Mock handlers are automatically generated by Orval when you run:

```bash
npm run generate:api
```

This creates:
- API types and hooks
- Mock response generators (using faker)
- Mock handlers (using MSW)

### Available Handlers

The generated file includes handlers for all API endpoints:

```typescript
// In nutriAIFoodCalorieTrackerAPI.ts
export const getNutriAIFoodCalorieTrackerAPIMock = () => [
  getPostAuthSignupMockHandler(),
  getPostAuthLoginMockHandler(),
  getPostAuthGoogleMockHandler(),
  getGetCalendarMockHandler(),
  getGetDayDateMockHandler(),
  getPostDayDateMealsMockHandler(),
  // ... all other endpoints
];
```

### Custom Mock Responses

You can customize mock responses by passing override functions:

```typescript
// Example: Custom login mock
const customLoginHandler = getPostAuthLoginMockHandler(
  (info) => {
    // Custom logic
    return {
      token: "custom-token",
      user: {
        id: "123",
        email: "test@example.com",
        // ...
      }
    };
  }
);
```

## How It's Integrated

### 1. MSWProvider Component

The `MSWProvider` component wraps your entire application and:
- Checks if mock mode is enabled
- Initializes MSW service worker
- Shows loading state while MSW is starting
- Renders children only after MSW is ready

```tsx
// In app-provider.tsx
export function AppProvider({ children }: { children?: React.ReactNode }) {
  return (
    <MSWProvider>
      {/* Other providers */}
      {children}
    </MSWProvider>
  );
}
```

### 2. Lazy Loading

MSW is loaded dynamically only in the browser to avoid SSR issues:

```typescript
// browser.ts
export async function getWorker() {
  if (typeof window === "undefined") {
    throw new Error("MSW browser worker can only be used in browser environment");
  }

  const { setupWorker } = await import("msw/browser");
  const { getNutriAIFoodCalorieTrackerAPIMock } = await import(
    "@/shared/api/generated/nutriAIFoodCalorieTrackerAPI"
  );

  return setupWorker(...getNutriAIFoodCalorieTrackerAPIMock());
}
```

## Usage

### Development with Mocks

1. Ensure `.env` has `NEXT_PUBLIC_USE_MOCK_API=true`
2. Start the dev server: `npm run dev`
3. Open your browser console - you should see:
   ```
   ðŸ”§ Mock API mode enabled
   âœ… MSW started successfully
   [MSW] Mocking enabled.
   ```
4. All API requests will now return mock data

### Switching to Real API

1. Update `.env`:
   ```bash
   NEXT_PUBLIC_USE_MOCK_API=false
   NEXT_PUBLIC_API_BASE_URL=http://localhost:3333/api
   ```
2. Restart the dev server
3. Ensure your backend is running
4. Requests now go to real API

## Debugging

### Check MSW Status

Open browser console:
- With mocks: `ðŸ”§ Mock API mode enabled` â†’ `âœ… MSW started successfully`
- Without mocks: `ðŸ“¡ Using real API: http://localhost:3333/api`

### Common Issues

**Issue: "Failed to fetch mockServiceWorker.js"**
- Solution: Run `npx msw init public/` to regenerate the service worker

**Issue: "MSW not intercepting requests"**
- Check console for MSW initialization messages
- Verify `NEXT_PUBLIC_USE_MOCK_API=true` in `.env`
- Hard refresh browser (Cmd+Shift+R or Ctrl+Shift+R)

**Issue: "Build fails with MSW error"**
- This is expected if you import MSW directly
- Always use dynamic imports as shown in `browser.ts`

### Inspecting Mock Data

MSW logs all intercepted requests to the console:
```
[MSW] POST /auth/login (200 OK)
```

You can also view the mock data being returned in the Network tab.

## Regenerating Mocks

When your API specification changes:

1. Update your OpenAPI spec file
2. Run: `npm run generate:api`
3. New mocks are automatically generated
4. No code changes needed - MSW picks them up automatically

## Best Practices

1. **Always use environment variables** - Never hardcode mock mode
2. **Don't commit real API keys** - Use mocks for development
3. **Test both modes** - Verify your app works with mocks AND real API
4. **Customize sparingly** - Let Orval generate most mocks
5. **Keep OpenAPI spec updated** - Mocks reflect your spec

## Production

In production:
- Set `NEXT_PUBLIC_USE_MOCK_API=false`
- MSW is completely disabled
- No performance impact
- No MSW code is included in the bundle

## Additional Resources

- [MSW Documentation](https://mswjs.io/)
- [Orval Documentation](https://orval.dev/)
- Project Auth Implementation: `docs/AUTH_IMPLEMENTATION.md`
